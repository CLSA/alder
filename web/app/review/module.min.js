cenozoApp.defineModule({name:"review",models:["add","list","view"],create:module=>{angular.extend(module,{identifier:{parent:{subject:"exam",column:"exam.id"}},name:{singular:"review",plural:"reviews",possessive:"review's"},columnList:{uid:{column:"participant.uid",title:"Participant"},phase:{column:"study_phase.name",title:"Phase"},site:{column:"site.name",title:"Site"},interviewer:{column:"exam.interviewer",title:"Interviewer"},scan_type:{title:"Type"},user:{column:"user.name",title:"Reviewer",isIncluded:function($state,model){return!model.isRole("typist")}},completed:{title:"Completed",type:"boolean"},notification:{title:"Notification",type:"string"}},defaultOrder:{column:"user.name",reverse:false}});module.addInputGroup("",{uid:{column:"participant.uid",title:"Participant",type:"string",isConstant:true,isExcluded:function($state,model){return"add"}},phase:{column:"study_phase.name",title:"Phase",type:"string",isConstant:true,isExcluded:function($state,model){return"add"}},site:{column:"site.name",title:"Site",type:"string",isConstant:true,isExcluded:function($state,model){return"add"}},interviewer:{column:"exam.interviewer",title:"Interviewer",type:"string",isConstant:true,isExcluded:function($state,model){return"add"}},scan_type:{title:"Type",type:"string",isConstant:true,isExcluded:function($state,model){return"add"}},user_id:{title:"Reviewer",type:"lookup-typeahead",typeahead:{table:"user",select:'CONCAT( user.first_name, " ", user.last_name, " (", user.name, ")" )',where:["user.first_name","user.last_name","user.name"]},isConstant:"view",isExcluded:function($state,model){return model.isRole("typist")}},completed:{title:"Completed",type:"boolean",isConstant:function($state,model){return!model.viewModel.isTypist()},isExcluded:function($state,model){return"add"}},notification:{title:"Notification",type:"enum",isExcluded:function($state,model){return"add_review"==model.getActionFromState()||!model.isRole("administrator")}},feedback:{title:"Feedback",type:"text",isConstant:function($state,model){return!model.viewModel.isTypist()},isExcluded:function($state,model){return"add"}},note:{column:"exam.note",title:"Exam Notes",type:"text",isExcluded:function($state,model){return"add"}}});if(angular.isDefined(module.actions.multiedit)){module.addExtraOperation("list",{title:"Review Multi-Edit",operation:async function($state,model){await $state.go("review.multiedit")},isIncluded:function($state,model){return"review"==model.getSubjectFromState()}})}module.addExtraOperation("view",{title:"Mark as Read",operation:async function($state,model){if(model.isRole("coordinator")){await model.viewModel.setNotification("read")}},isDisabled:function($state,model){return model.viewModel.changingNotification},isIncluded:function($state,model){return model.isRole("coordinator")&&"alert"==model.viewModel.record.notification}});module.addExtraOperation("view",{title:"Mark as Unread",operation:async function($state,model){if(model.isRole("coordinator")){await model.viewModel.setNotification("alert")}},isDisabled:function($state,model){return model.viewModel.changingNotification},isIncluded:function($state,model){return model.isRole("coordinator")&&"read"==model.viewModel.record.notification}});module.addExtraOperation("view",{title:"Alert Coordinator",operation:async function($state,model){await model.viewModel.setNotification("alert")},isDisabled:function($state,model){return model.viewModel.changingNotification},isIncluded:function($state,model){return model.isRole("typist")&&!model.viewModel.record.notification}});module.addExtraOperation("view",{title:"Remove Alert",operation:async function($state,model){await model.viewModel.setNotification("")},isDisabled:function($state,model){return model.viewModel.changingNotification},isIncluded:function($state,model){return model.isRole("typist")&&model.viewModel.record.notification}});cenozo.providers.directive("cnReviewMultiedit",["CnReviewMultieditFactory","CnSession","$state",function(CnReviewMultieditFactory,CnSession,$state){return{templateUrl:module.getFileUrl("multiedit.tpl.html"),restrict:"E",controller:function($scope){$scope.model=CnReviewMultieditFactory.instance();$scope.tab="review";CnSession.setBreadcrumbTrail([{title:"Reviews",go:async function(){await $state.go("review.list")}},{title:"Multi-Edit"}]);$scope.confirm=async function(){await $scope.model.confirm();angular.element("#uidListString").trigger("elastic")}}}}]);cenozo.providers.factory("CnReviewMultieditFactory",["CnReviewModelFactory","CnSession","CnHttpFactory","CnModalDatetimeFactory","CnModalMessageFactory",function(CnReviewModelFactory,CnSession,CnHttpFactory,CnModalDatetimeFactory,CnModalMessageFactory){var object=function(){angular.extend(this,{parentModel:CnReviewModelFactory.root,module:module,confirmInProgress:false,randomData:{canProceed:false,startDate:null,endDate:null,examsPerInterviewer:null,examDataList:null},uidData:{canProceed:false,uidListString:"",examDataList:null,withTotal:0,withoutTotal:0},studyPhaseList:[],studyPhaseId:null,modalityList:[],modalityId:null,selectionTypeList:[{name:"Random",value:"random"},{name:"UID",value:"uid"}],selectionType:"random",formattedStartDate:null,formattedEndDate:null,userList:null,userId:null,completedList:[{name:"(leave unchanged)",value:null},{name:"Yes",value:1},{name:"No",value:0}],completed:null,notificationList:[{name:"(leave unchanged)",value:null},{name:"Remove alert",value:""},{name:"Alert user",value:"alert"},{name:"Mark as read",value:"read"}],notification:null,selectDate:async function(type){const response=await CnModalDatetimeFactory.instance({title:"start"==type?"Start Date":"End Date",date:"start"==type?this.randomData.startDate:this.randomData.endDate,minDate:"end"==type?this.randomData.startDate:null,maxDate:"start"==type?this.randomData.endDate:null,pickerType:"date",emptyAllowed:false}).show();if(false!==response){if("start"==type){this.randomData.startDate=response;this.formattedStartDate=CnSession.formatValue(response,"date",true)}else{this.randomData.endDate=response;this.formattedEndDate=CnSession.formatValue(response,"date",true)}await this.selectionChanged("random")}},sanitizeExamsPerInterviewer:function(){this.randomData.examsPerInterviewer=Number(this.randomData.examsPerInterviewer.replace(/[^0-9]/g,""))},selectionChanged:async function(type){if("random"==this.selectionType&&this.randomData.startDate&&this.randomData.endDate||"uid"==this.selectionType&&angular.isDefined(this.uidData.uidListString)&&0<this.uidData.uidListString.length){await this.confirm()}},confirm:async function(){this.confirmInProgress=true;if("random"==this.selectionType)this.randomData.canProceed=false;else if("uid"==this.selectionType)this.uidData.canProceed=false;let data={};if(this.studyPhaseId)data.study_phase_id=this.studyPhaseId;if(this.modalityId)data.modality_id=this.modalityId;try{if(null==this.userList){var response=await CnHttpFactory.instance({path:"user",data:{select:{distinct:true,column:["id","name","first_name","last_name"]},modifier:{join:[{table:"access",onleft:"user.id",onright:"access.user_id"},{table:"role",onleft:"access.role_id",onright:"role.id"}],where:[{column:"user.active",operator:"=",value:true},{column:"role.name",operator:"=",value:"typist"}],order:"user.name"}}}).query();this.userList=response.data.reduce((list,item)=>{list.push({value:item.id,name:item.first_name+" "+item.last_name+" ("+item.name+")",user:item.name});return list},[]);this.userList.unshift({name:"(empty)",value:null})}if("random"==this.selectionType){angular.extend(data,{start_date:this.randomData.startDate.replace(/T.*/,""),end_date:this.randomData.endDate.replace(/T.*/,"")});var response=await CnHttpFactory.instance({path:"review",data:data}).post();this.randomData.examDataList=response.data;this.randomData.canProceed=0<Object.keys(this.randomData.examDataList).length}else{var uidRegex=new RegExp(CnSession.application.uidRegex);var fixedList=this.uidData.uidListString.toUpperCase().replace(/[\s,;|\/]/g," ").replace(/[^a-zA-Z0-9 ]/g,"").split(" ").filter(uid=>null!=uid.match(uidRegex)).filter((uid,index,array)=>index<=array.indexOf(uid)).sort();if(0==fixedList.length){angular.extend(this.uidData,{uidListString:"",examDataList:null,withTotal:0,withoutTotal:0})}else{data.uid_list=fixedList;var response=await CnHttpFactory.instance({path:"review",data:data}).post();angular.extend(this.uidData,{uidListString:response.data.uid_list.join(" "),examDataList:response.data.exam_list});this.uidData.canProceed=0<this.uidData.uidListString.length;angular.extend(this.uidData,{withTotal:0,withoutTotal:0});for(phase in this.uidData.examDataList){for(modality in this.uidData.examDataList[phase]){this.uidData.withTotal+=Number(this.uidData.examDataList[phase][modality].with);this.uidData.withoutTotal+=Number(this.uidData.examDataList[phase][modality].without)}}}}}finally{this.confirmInProgress=false}},proceed:async function(type){if("random"==this.selectionType){let data={exams_per_interviewer:this.randomData.examsPerInterviewer,start_date:this.randomData.startDate.replace(/T.*/,""),end_date:this.randomData.endDate.replace(/T.*/,""),user_id:this.userId,process:true};if(angular.isDefined(this.studyPhaseId))data.study_phase_id=this.studyPhaseId;if(angular.isDefined(this.modalityId))data.modality_id=this.modalityId;const response=await CnHttpFactory.instance({path:"review",data:data,onError:CnModalMessageFactory.httpError}).post();await CnModalMessageFactory.instance({title:"Review(s) Processed",message:"A total of "+response.data+" new reviews have been assigned."}).show();this.userId=null}else if("uid"==this.selectionType){let uidList=this.uidData.uidListString.split(" ");let data={uid_list:uidList,process:true};if(angular.isDefined(this.studyPhaseId))data.study_phase_id=this.studyPhaseId;if(angular.isDefined(this.modalityId))data.modality_id=this.modalityId;if(0<this.uidData.withoutTotal){if(angular.isDefined(this.userId))data.user_id=this.userId}if(0<this.uidData.withTotal){if(angular.isDefined(this.completed))data.completed=this.completed;if(angular.isDefined(this.notification))data.notification=this.notification}const response=await CnHttpFactory.instance({path:"review",data:data,onError:CnModalMessageFactory.httpError}).post();let message="A total of "+uidList.length+" participant"+(1!=uidList.length?"s have ":" has ")+"been processed";if(0<response.data.new||0<response.data.edit){message+=" (";if(0<response.data.new){message+=response.data.new+" new review"+(1!=response.data.new?"s":"")+" assigned"}if(0<response.data.new&&0<response.data.edit)message+=" and ";if(0<response.data.edit){message+=response.data.edit+" review"+(1!=response.data.edit?"s":"")+" edited"}message+=")"}message+=".";await CnModalMessageFactory.instance({title:"Review(s) Processed",message:message}).show();angular.extend(this.uidData,{canProceed:false,uidListString:"",examDataList:null,withTotal:0,withoutTotal:0})}}});async function init(object){const[studyPhaseResponse,modalityResponse]=await Promise.all([CnHttpFactory.instance({path:"study_phase",data:{select:{column:["id","name"]},modifier:{join:[{table:"study",onleft:"study_phase.study_id",onright:"study.id"}],where:[{column:"study.name",operator:"=",value:"clsa"}],order:"study_phase.rank"}}}).query(),CnHttpFactory.instance({path:"modality",data:{select:{column:["id","name"]},modifier:{order:"modality.name"}}}).query()]);object.studyPhaseList=studyPhaseResponse.data.reduce((list,item)=>{list.push({value:item.id,name:item.name});return list},[]);object.studyPhaseList.unshift({name:"(all)",value:null});object.modalityList=modalityResponse.data.reduce((list,item)=>{list.push({value:item.id,name:item.name});return list},[]);object.modalityList.unshift({name:"(all)",value:null})}init(this)};return{instance:function(){return new object(false)}}}]);cenozo.providers.factory("CnReviewViewFactory",["CnBaseViewFactory","CnSession","CnHttpFactory","CnModalMessageFactory",function(CnBaseViewFactory,CnSession,CnHttpFactory,CnModalMessageFactory){var object=function(parentModel,root){CnBaseViewFactory.construct(this,parentModel,root);angular.extend(this,{analysisList:[],analysisIndex:null,canvas:null,context:null,image:null,canvasRatio:null,imageRatio:null,transform:{x:0,y:0,b:1,c:1,scale:1},activeAnnotation:null,hover:{type:null,handle:null,id:null},bounds:{x:{min:0,max:1},y:{min:0,max:1},b:{min:.5,max:2},c:{min:1,max:10},scale:{min:1,max:16}},changingNotification:false,setNotification:async function(value){try{this.changingNotification=true;await this.onPatch({notification:value});this.record.notification=value}catch(error){}finally{this.changingNotification=false}},isTypist:function(){return this.parentModel.isRole("typist")&&this.record.user_id==CnSession.user.id},nextAnalysis:function(){if(this.analysisList.length-1>this.analysisIndex){this.analysisIndex++;this.loadAnalysis()}},prevAnalysis:function(){if(0<this.analysisIndex){this.analysisIndex--;this.loadAnalysis()}},onView:async function(force){await this.$$onView();this.isLoading=true;try{const response=await CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"/analysis"}).query();this.analysisList=response.data.map(record=>({record:record,filename:null,imageSrc:null,annotationList:[],codeGroupList:[]}));this.canvas=document.getElementById("canvas");const rect=this.canvas.getBoundingClientRect();this.canvas.width=rect.width*window.devicePixelRatio;this.canvas.height=rect.height*window.devicePixelRatio;this.context=this.canvas.getContext("2d");this.context.scale(window.devicePixelRatio,window.devicePixelRatio);this.drawNotice("loading image(s)...");this.image=new Image;this.image.onload=(()=>{this.imageRatio=this.image.width/this.image.height;this.reset();this.paint()});await Promise.all(this.analysisList.map(async analysis=>{const[codeResponse,imageResponse,annotationResponse]=await Promise.all([CnHttpFactory.instance({path:["analysis",analysis.record.id,"code?full=1"].join("/")}).query(),CnHttpFactory.instance({path:["image",analysis.record.image_id].join("/"),data:{select:{column:["filename","image"]}}}).get(),CnHttpFactory.instance({path:["analysis",analysis.record.id,"annotation"].join("/")}).query()]);angular.extend(analysis,{filename:imageResponse.data.filename,imageSrc:0==imageResponse.data.image.size?null:imageResponse.data.image.data,annotationList:annotationResponse.data.reduce((list,a)=>{list.push({id:a.id,type:a.type,x0:a.x0,y0:a.y0,x1:a.x1,y1:a.y1});return list},[]),codeGroupList:codeResponse.data});analysis.codeGroupList.forEach(g=>g.code_list.map(c=>{c.working=false;return c}))}));this.analysisIndex=0<response.data.length?0:null;this.loadAnalysis()}finally{this.isLoading=false}},loadAnalysis:function(){const analysis=null==this.analysisIndex?null:this.analysisList[this.analysisIndex];if(null==analysis||null==analysis.imageSrc){this.drawNotice("No image found")}else{this.image.src=analysis.imageSrc;this.createEventListeners()}},calculateRating:function(){let rating=5;this.analysisList[this.analysisIndex].codeGroupList.forEach(group=>{let inGroup=false;group.code_list.filter(code=>code.selected).forEach(code=>{rating+=code.value;inGroup=true});if(inGroup)rating+=group.value});if(1>rating)rating=1;else if(5<rating)rating=5;this.record.rating=rating},getCodeDescription:function(code){return(code.description?code.description+" ":"")+(0==code.value?"":"("+code.value+")")},toggleCode:async function(code){code.working=true;try{const self=this;if(code.selected){const identifierList=["review_id="+this.record.id,"code_type_id="+code.code_type_id];await CnHttpFactory.instance({path:"code/"+identifierList.join(";"),onError:function(error){if(404==error.status){console.info("The above 404 error can be safely ignored.");code.selected=!code.selected;self.calculateRating()}else CnModalMessageFactory.httpError(error)}}).delete()}else{const analysis=this.analysisList[this.analysisIndex];await CnHttpFactory.instance({path:["analysis",analysis.record.id,"code"].join("/"),data:{image_id:this.record.id,code_type_id:code.code_type_id},onError:function(error){if(409==error.status){console.info("The above 409 error can be safely ignored.");code.selected=!code.selected;self.calculateRating()}else CnModalMessageFactory.httpError(error)}}).post()}code.selected=!code.selected;this.calculateRating()}catch(error){}finally{code.working=false}},updateView:function(scale){const rect=this.canvas.getBoundingClientRect();this.canvas.width=rect.width*window.devicePixelRatio;this.canvas.height=rect.height*window.devicePixelRatio;this.canvasRatio=this.canvas.width/this.canvas.height;this.heightBased=this.canvasRatio>this.imageRatio;this.irRatio=this.heightBased?this.image.height/rect.height:this.image.width/rect.width;this.icRatio=this.heightBased?this.image.height/this.canvas.height:this.image.width/this.canvas.width;this.canvasView={x:0,y:0,width:this.heightBased?this.canvas.height*this.imageRatio:this.canvas.width,height:this.heightBased?this.canvas.height:this.canvas.width/this.imageRatio};this.bounds.x.max=0;this.bounds.y.max=0;if(this.heightBased){this.bounds.x.max=this.image.width-this.image.height/scale*this.canvasRatio;this.bounds.y.max=this.image.height-this.image.height/scale}else{this.bounds.x.max=this.image.width-this.image.width/scale;this.bounds.y.max=this.image.height-this.image.width/scale/this.canvasRatio}if(this.bounds.x.min>this.bounds.x.max)this.bounds.x.max=this.bounds.x.min;if(this.bounds.y.min>this.bounds.y.max)this.bounds.y.max=this.bounds.y.min},canvasToImage:function(x,y){const rect=this.canvas.getBoundingClientRect();return{x:(x-rect.x)*this.irRatio/this.transform.scale+this.transform.x,y:(y-rect.y)*this.irRatio/this.transform.scale+this.transform.y}},imageToCanvas:function(x,y){const rect=this.canvas.getBoundingClientRect();return{x:(x-this.transform.x)*this.transform.scale/this.icRatio,y:(y-this.transform.y)*this.transform.scale/this.icRatio}},reset:function(){this.transform={x:0,y:0,b:1,c:1,scale:1};this.hover={type:null,handle:null,id:null}},drawNotice:function(notice){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.font="18px Arial";this.context.fillText(notice,20,40)},drawAnnotation:function(annotation){let p0=this.imageToCanvas(annotation.x0,annotation.y0);let p1=this.imageToCanvas(annotation.x1,annotation.y1);this.context.lineWidth=2;this.context.strokeStyle="blue";this.context.fillStyle="blue";if("arrow"==annotation.type){let a=Math.atan((p1.y-p0.y)/(p1.x-p0.x))+(p1.x<p0.x?Math.PI:0);this.context.beginPath();this.context.moveTo(p0.x,p0.y);this.context.lineTo(p1.x,p1.y);this.context.stroke();if(this.hover.id==annotation.id){if(["all","start"].includes(this.hover.handle)){this.context.beginPath();this.context.arc(p0.x,p0.y,6,0,2*Math.PI);this.context.stroke()}if(["all","end"].includes(this.hover.handle)){this.context.beginPath();this.context.arc(p1.x,p1.y,6,0,2*Math.PI);this.context.stroke()}}this.context.translate(p1.x,p1.y);this.context.rotate(a);this.context.translate(-p1.x,-p1.y);this.context.beginPath();this.context.moveTo(p1.x+1,p1.y);this.context.lineTo(p1.x-10,p1.y-6);this.context.lineTo(p1.x-10,p1.y+6);this.context.fill();this.context.translate(p1.x,p1.y);this.context.rotate(-a);this.context.translate(-p1.x,-p1.y)}else if("ellipse"==annotation.type){let cx=(p0.x+p1.x)/2;let cy=(p0.y+p1.y)/2;let rx=Math.abs(p1.x-p0.x)/2;let ry=Math.abs(p1.y-p0.y)/2;this.context.beginPath();this.context.ellipse(cx,cy,rx,ry,0,0,2*Math.PI);this.context.stroke();if(this.hover.id==annotation.id){if(["all","nw"].includes(this.hover.handle)){this.context.beginPath();this.context.arc(cx-rx,cy-ry,6,0,2*Math.PI);this.context.stroke()}if(["all","sw"].includes(this.hover.handle)){this.context.beginPath();this.context.arc(cx-rx,cy+ry,6,0,2*Math.PI);this.context.stroke()}if(["all","se"].includes(this.hover.handle)){this.context.beginPath();this.context.arc(cx+rx,cy+ry,6,0,2*Math.PI);this.context.stroke()}if(["all","ne"].includes(this.hover.handle)){this.context.beginPath();this.context.arc(cx+rx,cy-ry,6,0,2*Math.PI);this.context.stroke()}}}},paint:function(){if(null==this.transform)this.reset();this.updateView(this.transform.scale);this.context.scale(this.transform.scale,this.transform.scale);this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.filter="brightness("+100*this.transform.b+"%) "+"contrast("+100*this.transform.c+"%)";this.context.drawImage(this.image,this.transform.x,this.transform.y,this.image.width,this.image.height,this.canvasView.x,this.canvasView.y,this.canvasView.width,this.canvasView.height);this.context.scale(1/this.transform.scale,1/this.transform.scale);const annotationList=this.analysisList[this.analysisIndex].annotationList;annotationList.forEach(annotation=>this.drawAnnotation(annotation));if(null!=this.activeAnnotation){this.drawAnnotation(this.activeAnnotation)}},scale:function(cx,cy,inward){let imageMeasure=this.heightBased?this.image.height:this.image.width;let scaleFactor=(inward?1:-1)*imageMeasure/32;let newScale=imageMeasure/(imageMeasure/this.transform.scale-scaleFactor);if(this.bounds.scale.min>newScale||this.bounds.scale.max<newScale)return;let x=0,y=0;if(1<newScale){x=this.transform.x+scaleFactor*cx*(this.heightBased?this.canvasRatio:1);y=this.transform.y+scaleFactor*cy*(this.heightBased?1:1/this.canvasRatio)}this.updateView(newScale);angular.extend(this.transform,{x:this.bounds.x.min>x?this.bounds.x.min:this.bounds.x.max<x?this.bounds.x.max:x,y:this.bounds.x.min>y?this.bounds.x.min:this.bounds.y.max<y?this.bounds.y.max:y,scale:newScale});this.paint()},pan:function(dx,dy){let x=this.transform.x+dx*this.irRatio/this.transform.scale;let y=this.transform.y+dy*this.irRatio/this.transform.scale;angular.extend(this.transform,{x:this.bounds.x.min>x?this.bounds.x.min:this.bounds.x.max<x?this.bounds.x.max:x,y:this.bounds.x.min>y?this.bounds.x.min:this.bounds.y.max<y?this.bounds.y.max:y});this.paint()},windowLevel:function(dc,db){let b=this.transform.b+(this.bounds.b.max-this.bounds.b.min)*db/600;let c=this.transform.c+(this.bounds.c.max-this.bounds.c.min)*dc/600;angular.extend(this.transform,{b:b=b<this.bounds.b.min?this.bounds.b.min:b>this.bounds.b.max?this.bounds.b.max:b,c:c=c<this.bounds.c.min?this.bounds.c.min:c>this.bounds.c.max?this.bounds.c.max:c});this.paint()},createAnnotation:function(type,point){if(!this.isTypist())return;this.activeAnnotation={id:null,type:type};angular.extend(this.activeAnnotation,{x0:point.x,y0:point.y,x1:null,y1:null,grab:"arrow"==this.activeAnnotation.type?"end":"se"})},updateActiveAnnotation:function(point){if(!this.isTypist())return;let annotation=null;if(null!=this.hover.id){const annotationList=this.analysisList[this.analysisIndex].annotationList;let index=annotationList.findIndexByProperty("id",this.hover.id);if(null!=index){annotation=annotationList[index];annotationList.splice(index,1);annotation.grab="all"==this.hover.handle?point:this.hover.handle}}this.activeAnnotation=annotation},deleteActiveAnnotation:async function(){if(!this.isTypist())return;if(null==this.hover.id)return;const annotationList=this.analysisList[this.analysisIndex].annotationList;let index=annotationList.findIndexByProperty("id",this.hover.id);if(null!=index){let id=this.hover.id;annotationList.splice(index,1);this.hover={handle:null,id:null};this.paint();const analysis=this.analysisList[this.analysisIndex];await CnHttpFactory.instance({path:["analysis",analysis.record.id,"annotation",id].join("/")}).delete()}},saveActiveAnnotation:async function(){if(!this.isTypist())return;if(null==this.activeAnnotation)return;let annotation=this.activeAnnotation;let data={type:annotation.type,x0:annotation.x0,y0:annotation.y0,x1:annotation.x1,y1:annotation.y1};let valid=null!=this.activeAnnotation.x0&&null!=this.activeAnnotation.x1&&null!=this.activeAnnotation.y0&&null!=this.activeAnnotation.y1&&(this.activeAnnotation.x0!=this.activeAnnotation.x1||this.activeAnnotation.y0!=this.activeAnnotation.y1);if(valid&&null!=annotation){try{const analysis=this.analysisList[this.analysisIndex];let httpObj={path:["analysis",analysis.record.id,"annotation"].join("/"),data:data,onError:function(error){}};if(null==annotation.id){const response=await CnHttpFactory.instance(httpObj).post();annotation.id=response.data}else{httpObj.path+="/"+annotation.id;await CnHttpFactory.instance(httpObj).patch()}this.analysisList[this.analysisIndex].annotationList.push(annotation)}catch(error){}}this.activeAnnotation=null;this.paint()},updateHover:function(point){if(!this.isTypist())return;const dh=16/this.transform.scale;const annotationList=this.analysisList[this.analysisIndex].annotationList;let hover=annotationList.some(annotation=>{let handle=null;if(dh>Math.abs(point.x-annotation.x0)&&dh>Math.abs(point.y-annotation.y0)){handle="arrow"==annotation.type?"start":"nw"}else if(dh>Math.abs(point.x-annotation.x1)&&dh>Math.abs(point.y-annotation.y0)){handle="ne"}else if(dh>Math.abs(point.x-annotation.x1)&&dh>Math.abs(point.y-annotation.y1)){handle="arrow"==annotation.type?"end":"se"}else if(dh>Math.abs(point.x-annotation.x0)&&dh>Math.abs(point.y-annotation.y1)){handle="sw"}if(null!=handle){angular.extend(this.hover,{handle:handle,id:annotation.id});return true}});if(!hover){hover=annotationList.some(annotation=>{let b={x0:annotation.x0<annotation.x1?annotation.x0:annotation.x1,x1:annotation.x0<annotation.x1?annotation.x1:annotation.x0,y0:annotation.y0<annotation.y1?annotation.y0:annotation.y1,y1:annotation.y0<annotation.y1?annotation.y1:annotation.y0};if(b.x0<=point.x&&point.x<=b.x1&&b.y0<=point.y&&point.y<=b.y1){angular.extend(this.hover,{handle:"all",id:annotation.id});return true}})}if(!hover)this.hover={handle:null,id:null};this.paint()},transformActiveAnnotation:function(point){if(!this.isTypist())return;let aa=this.activeAnnotation;if(null!=aa){if("nw"==aa.grab){aa.grab=point.x>aa.x1?"ne":point.y>aa.y1?"sw":"nw"}else if("ne"==aa.grab){aa.grab=point.x<aa.x0?"nw":point.y>aa.y1?"se":"ne"}else if("se"==aa.grab){aa.grab=point.x<aa.x0?"sw":point.y<aa.y0?"ne":"se"}else if("sw"==aa.grab){aa.grab=point.x>aa.x1?"se":point.y<aa.y0?"nw":"sw"}this.hover.handle=aa.grab;if(["nw","start"].includes(aa.grab)){angular.extend(aa,{x0:point.x,y0:point.y})}else if("ne"==aa.grab){angular.extend(aa,{x1:point.x,y0:point.y})}else if(["se","end"].includes(aa.grab)){angular.extend(aa,{x1:point.x,y1:point.y})}else if("sw"==aa.grab){angular.extend(aa,{x0:point.x,y1:point.y})}else if(angular.isObject(aa.grab)){aa.x0+=point.x-aa.grab.x;aa.y0+=point.y-aa.grab.y;aa.x1+=point.x-aa.grab.x;aa.y1+=point.y-aa.grab.y;aa.grab.x=point.x;aa.grab.y=point.y}this.paint()}},createEventListeners:function(){window.addEventListener("resize",()=>{this.paint()});window.addEventListener("keydown",async event=>{if(this.canvas.parentNode.matches(":hover")){event.preventDefault();event.stopPropagation();if("Delete"==event.key){await this.deleteActiveAnnotation()}else if("Escape"==event.key){this.reset();this.paint()}}});window.addEventListener("mouseout",event=>{if(this.activeAnnotation){this.activeAnnotation=null;this.paint()}});angular.extend(this.canvas,{oncontextmenu:event=>{event.preventDefault();event.stopPropagation()},onmousedown:event=>{let button=null;if(0==event.button)button="left";else if(1==event.button)button="middle";else if(2==event.button)button="right";const point=this.canvasToImage(event.clientX,event.clientY);if(event.altKey){}else if(event.ctrlKey){if("left"==button)this.createAnnotation("arrow",point)}else if(event.shiftKey){if("left"==button)this.createAnnotation("ellipse",point)}else{if("left"==button&&null==this.activeAnnotation){this.updateActiveAnnotation(point)}}},onmouseup:async event=>{let button=null;if(0==event.button)button="left";else if(1==event.button)button="middle";else if(2==event.button)button="right";if("left"==button&&null!=this.activeAnnotation){await this.saveActiveAnnotation()}},onwheel:event=>{event.preventDefault();event.stopPropagation();const rect=this.canvas.getBoundingClientRect();this.scale(event.layerX/rect.width,event.layerY/rect.height,0<event.wheelDelta)},onmousemove:event=>{let button=null;if(1==event.buttons)button="left";else if(4==event.buttons)button="middle";else if(2==event.buttons)button="right";const point=this.canvasToImage(event.clientX,event.clientY);if(null==button){if(!event.altKey&&!event.ctrlKey&&!event.shiftKey){this.updateHover(point)}}else if("left"==button){this.transformActiveAnnotation(point)}else if("middle"==button){this.pan(-event.movementX,-event.movementY)}else if("right"==button){this.windowLevel(event.movementX,-event.movementY)}}})}})};return{instance:function(parentModel,root){return new object(parentModel,root)}}}]);cenozo.providers.factory("CnReviewAddFactory",["CnBaseAddFactory","CnHttpFactory",function(CnBaseAddFactory,CnHttpFactory){var object=function(parentModel){CnBaseAddFactory.construct(this,parentModel);this.onNew=async function(record){this.heading="Create "+parentModel.module.name.singular.ucWords()+" for Image "+this.parentModel.getParentIdentifier().identifier}};return{instance:function(parentModel){return new object(parentModel)}}}]);cenozo.providers.factory("CnReviewModelFactory",["CnBaseModelFactory","CnReviewAddFactory","CnReviewListFactory","CnReviewViewFactory","CnSession","CnHttpFactory","CnModalMessageFactory",function(CnBaseModelFactory,CnReviewAddFactory,CnReviewListFactory,CnReviewViewFactory,CnSession,CnHttpFactory,CnModalMessageFactory){var object=function(root){CnBaseModelFactory.construct(this,module);angular.extend(this,{addModel:CnReviewAddFactory.instance(this),listModel:CnReviewListFactory.instance(this),viewModel:CnReviewViewFactory.instance(this,root),getServiceCollectionPath:function(){return this.$$getServiceCollectionPath("root"==this.getSubjectFromState())},getServiceData:function(type,columnRestrictLists){var data=this.$$getServiceData(type,columnRestrictLists);if("root"==this.getSubjectFromState()&&this.isRole("coordinator","typist")){if(angular.isUndefined(data.modifier.where))data.modifier.where=[];if(this.isRole("coordinator")){data.modifier.where.push({column:"review.notification",operator:"=",value:"alert"})}else if(this.isRole("typist")){data.modifier.where.push({column:"review.user_id",operator:"=",value:CnSession.user.id});data.modifier.where.push({column:"review.completed",operator:"=",value:false})}}return data},getTypeaheadData:function(input,viewValue){let data=this.$$getTypeaheadData(input,viewValue);if("user"==input.typeahead.table){if(angular.isUndefined(data.modifier.join))data.modifier.join=[];data.modifier.join.push({table:"access",onleft:"user.id",onright:"access.user_id"});data.modifier.join.push({table:"role",onleft:"access.role_id",onright:"role.id"});data.modifier.where.push({column:"role.name",operator:"=",value:"typist"})}return data},getAddEnabled:function(){return this.$$getAddEnabled()&&"exam"==this.getSubjectFromState()&&["add_review","view"].includes(this.getActionFromState())},transitionToAddState:async function(){if("typist"==CnSession.role.name){try{var response=await CnHttpFactory.instance({path:"review",data:{user_id:CnSession.user.id},onError:async function(error){if(408==error.status){CnModalMessageFactory.instance({title:"No Images Available",message:error.data,error:true}).show()}else if(409==error.status){await CnModalMessageFactory.instance({title:"Cannot Begin New Review",message:error.data,error:true}).show()}else CnModalMessageFactory.httpError(error)}}).post();await this.transitionToViewState({getIdentifier:function(){return response.data}})}catch(error){}}else{await this.$$transitionToAddState()}}})};return{root:new object(true),instance:function(){return new object(false)}}}])}});
